<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.min.css" rel="stylesheet">
    <!-- Optional JavaScript -->
    <script src="https://cdn.datatables.net/2.3.2/js/dataTables.min.js"></script>

    <title>Bản tin thị trường</title>
    <link rel="icon" href="favicon.png" type="image/png">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg fixed-top" style="background-color: #e3f2fd;" data-bs-theme="light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#"><img width="30px" height="30px" src="favicon.png"/> Bản tin tuần</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-link" href="index.html">Lịch chỉ số</a>
            <a class="nav-link" href="tinvimo.html">Tin vĩ mô</a>
            <a class="nav-link" href="chisovimo.html">Chỉ số vĩ mô</a>
            <a class="nav-link" href="thitruong1.html">Thị trường I</a>
            <a class="nav-link active" aria-current="page" href="#">Thị trường II</a>
            <a class="nav-link" href="nhandinh.html">Nhận định</a>
          </div>
        </div>
      </div>
    </nav>
    <br><br><br>
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-6">
          <label>From: <input type="date" id="minDate"></label>
          <label>To: <input type="date" id="maxDate"></label>
          <h4 class="text-center">Diễn biến từ ngày <span id="fromDate"></span> đến ngày <span id="toDate"></span></h4>
          <table id="tonghop" class="display" style="width:100%"></table>
          <canvas id="myChart"></canvas>
          <canvas id="myChart1"></canvas>
        </div>
        <div class="col-lg-6">
          <table id="omo_cashflow" class="display" style="width:100%"></table>
        </div>
      </div>
    </div>
  <script>
    var dataTonghop = [];
// 1. Create custom filter function
$.fn.dataTable.ext.search.push(
    function(settings, data, dataIndex) {
        var min = $('#minDate').val();
        var max = $('#maxDate').val();
        var date = data[0]; // use column index for date (2nd col = index 1)

        if (!date) return false;

        // Parse date from string (assuming format YYYY-MM-DD)
        var d = new Date(date);

        if (
            (min === "" || new Date(min) <= d) &&
            (max === "" || new Date(max) >= d)
        ) {
            return true;
        }
        return false;
    }
);

function getChartData(table) {
  var labels = [];
  var values = [];
  var vniborons = [];
  var vnibor3ms = [];
  var usdvnds = [];
  var tygiasbvs = [];
  table.rows({ search: 'applied' }).every(function () {
    var data = this.data();
    labels.push(data[0]);
    values.push(data[3]);
    vniborons.push(data[4]);
    vnibor3ms.push(data[5]);
    tygiasbvs.push(data[6]);
    usdvnds.push(data[7]);
  });
  return { labels, values, vniborons, vnibor3ms, usdvnds, tygiasbvs };
}

function getChartData1(table) {
  var labels = [];
  var vniborons = [];
  var usdvnds = [];
  var tygiasbvs = [];
  table.rows({ search: 'applied' }).every(function () {
    var data = this.data();
    labels.push(data[0]);
    vniborons.push(data[4]);
    usdvnds.push(data[7]);
    tygiasbvs.push(data[6]);
  });
  return { labels, vniborons, usdvnds, tygiasbvs };
}

    $.getJSON('omo_cashflow.json?' + new Date().getTime(), function(data) {
      //console.log(data);
      dataOmoCashflow = [];
      dataTygia = [];
      data.forEach((item,index) => {
        dataOmoCashflow[index] = [item.date, parseFloat(item.inflow), parseFloat(item.outflow), parseFloat(item.net), parseFloat(item["VNIBOR-ON"]), parseFloat(item["VNIBOR-3M"]), parseFloat(item.tygiasbv), parseFloat(item.usdvnd)];
        dataTygia[index] = [item.date, parseFloat(item.tygiasbv), parseFloat(item.usdvnd), parseFloat(item["VNIBOR-ON"])];
        //console.log(item);
      }); 
      //VNIBOR-ON và hành động trên thị trường OMO
      var table = new DataTable('#omo_cashflow', {
        data: dataOmoCashflow,
        columns: [
          { title: 'Ngày' },
          { title: 'Hút' },
          { title: 'Bơm' },
          { title: 'Bơm ròng' },
          { title: 'VNIBOR-ON' },
          { title: 'VNIBOR-3M' },
          { title: 'Tỷ giá SBV' },
          { title: 'Tỷ giá USDVND' }
        ],
        order: [[0, 'asc']],
        pageLength: 25
      });
      const ctx = document.getElementById('myChart').getContext("2d");
      var chartData = getChartData(table);
      console.log(chartData);
      var myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Bơm hút ròng OMO',
            data: chartData.values,
            type: 'bar',
            yAxisID: 'y',
          },{
            label: 'VNIBOR-ON',
            data: chartData.vniborons,
            type: 'line',
            yAxisID: 'y1'
          },{
            label: 'VNIBOR-3M',
            data: chartData.vnibor3ms,
            type: 'line',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: "Lãi suất VNIBOR (%) và hoạt động thị trường mở OMO (tỷ đồng)"
            },
            legend: {
              display: true,
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              position: 'left'
            },
            y1: {
              position: 'right'
            }
          },
        }
      });
      //Tổng hợp thông tin thị trường
      var tableTonghop = new DataTable('#tonghop', {
        data: dataTonghop,
        columns: [
          { title: 'Chỉ số' },
          { title: 'Đầu' },
          { title: 'Cuối' },
          { title: '+/-', render: function(data){return parseFloat(data).toFixed(2);} },
          { title: 'Average', render: function(data){return parseFloat(data).toFixed(2);} },
          { title: 'Max' },
          { title: 'Min' }
        ],
        paging: false,
        searching: false,
        info: false,
      });

      //VNIBOR-ON và tỷ giá USD/VND
      const ctx1 = document.getElementById('myChart1').getContext("2d");
      var chartData1 = getChartData1(table);
      console.log(chartData1);
      var myChart1 = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: chartData1.labels,
          datasets: [{
            label: 'Tỷ giá USD/VND',
            data: chartData1.usdvnds,
            type: 'line',
            yAxisID: 'y',
          },{
            label: 'Tỷ giá trung tâm',
            data: chartData1.tygiasbvs,
            type: 'line',
            yAxisID: 'y',
          },{
            label: 'VNIBOR-ON',
            data: chartData1.vniborons,
            type: 'line',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: "Lãi suất VNIBOR (%) và tỷ giá USD/VND"
            },
            legend: {
              display: true,
              position: 'bottom'
            }
          },
          scales: {
            y: {
              position: 'left'
            },
            y1: {
              position: 'right'
            }
          },
        }
      });
      //Table filter and chart update
      table.on('draw', function () {
        var newData = getChartData(table);
        myChart.data.labels = newData.labels;
        myChart.data.datasets[0].data = newData.values;
        myChart.data.datasets[1].data = newData.vniborons;
        myChart.update();
        var newData1 = getChartData1(table);
        myChart1.data.labels = newData1.labels;
        myChart1.data.datasets[0].data = newData1.values;
        myChart1.data.datasets[1].data = newData1.usdvnds;
        myChart1.update();
        // Update date range in the title
        var fromDate = Math.min(...newData.labels.map(date => new Date(date).getTime()));
        var toDate = Math.max(...newData.labels.map(date => new Date(date).getTime()));
        $('#fromDate').text(new Date(fromDate).toISOString().slice(0, 10));
        $('#toDate').text(new Date(toDate).toISOString().slice(0, 10));
        dataTonghop = [
          ["Bơm ròng (tỷ)",newData.values[0],newData.values[newData.values.length - 1],newData.values.reduce((sum,value)=>sum+value,0),newData.values.reduce((sum,value)=>sum+value,0)/newData.values.length,Math.max(...newData.values),Math.min(...newData.values)],
          ["VNIBOR-ON (%)",newData.vniborons[0],newData.vniborons[newData.vniborons.length - 1],newData.vniborons[newData.vniborons.length - 1]-newData.vniborons[0], newData.vniborons.reduce((sum,value)=>sum+value,0)/newData.vniborons.length,Math.max(...newData.vniborons),Math.min(...newData.vniborons)],
          ["VNIBOR-3M (%)",newData.vnibor3ms[0],newData.vnibor3ms[newData.vnibor3ms.length - 1],newData.vnibor3ms[newData.vnibor3ms.length - 1]-newData.vnibor3ms[0], newData.vnibor3ms.reduce((sum,value)=>sum+value,0)/newData.vnibor3ms.length,Math.max(...newData.vnibor3ms),Math.min(...newData.vnibor3ms)],
          ["Tỷ giá USD/VND",newData.usdvnds[0],newData.usdvnds[newData.usdvnds.length - 1],newData.usdvnds[newData.usdvnds.length - 1]-newData.usdvnds[0], newData.usdvnds.reduce((sum,value)=>sum+value,0)/newData.usdvnds.length,Math.max(...newData.usdvnds),Math.min(...newData.usdvnds)],
          ["Tỷ giá trung tâm",newData.tygiasbvs[0],newData.tygiasbvs[newData.tygiasbvs.length - 1],newData.tygiasbvs[newData.tygiasbvs.length - 1]-newData.tygiasbvs[0], newData.tygiasbvs.reduce((sum,value)=>sum+value,0)/newData.tygiasbvs.length,Math.max(...newData.tygiasbvs),Math.min(...newData.tygiasbvs)]
        ];
        console.log("Diễn biến thị trường 2:",dataTonghop);
        tableTonghop.clear();
        tableTonghop.rows.add(dataTonghop).draw();
      });
      // 3. Redraw table when inputs change
      $('#minDate, #maxDate').on('change', function() {
          table.draw();
      });
    });      
  </script>
  </body>
</html>